% $Id: building.tex 4043 2015-06-23 13:50:07Z mskala $

\chapter{Building FontAnvil}

There are no immediate plans to build binary distribution packages; to use
this code you will have to build it yourself from sources.

\section{Dependencies}

Building FontAnvil requires several libraries and other resources.  FIXME
they should be listed here.

Building from a version control checkout also requires recent Autotools.

\section{From a version control checkout}

FontAnvil is available by anonymous Subversion checkout from
\url{http://svn.osdn.jp/svnroot/tsukurimashou/trunk/fontanvil/}. 
That is the main public repository for FontAnvil source code, and checking
out from there is (at least for the moment, while the code is in flux) the
preferred way to obtain FontAnvil.  The Tsukurimashou repository as a whole
is also mirrored on Github at
\url{https://github.com/mskala/Tsukurimashou.git}, but Git unfortunately
does not offer any easy way to clone only the FontAnvil portion of the
repository.

The version control system does not track files that would be included in a
distribution tarball but can be built automatically from source files
already under version control, and ``configure'' is one such, so it is
necessary to create it before building.  This will require having recent GNU
Autotools on your system.

\begin{verbatim}
autoreconf
automake --add-missing
autoreconf
\end{verbatim}

All three steps are necessary:  the first autoreconf will fail, but creates
files needed by automake, which in turn creates files needed for autoreconf
to finish its work.  All these commands will probably give a lot of error
and warning messages.  Then you can build and install in the usual way:

\begin{verbatim}
./configure
make
# as root:
make install
\end{verbatim}

The configure script supports \texttt{-{}-help} and most of the usual
options.
Note that FontAnvil's configure is a work in progress and may not correctly
detect or handle some libraries that it should.  Also still to do is a nice
display at the end of the configure run showing what libraries were and were
not found.

The build system should automatically detect and use multiple cores on a
computer that has them.

\section{From a distribution package}

Distribution packages are available from the FontAnvil home page at
\url{http://tsukurimashou.osdn.jp/fontanvil.php}.

Building from one is much the same as building from a version control
checkout, minus the need to build \texttt{configure}.  Unpack the tarball
file and do the usual Autotools build:

\begin{verbatim}
./configure
make
# as root:
make install
\end{verbatim}

\section{Testing}

FontAnvil includes a test suite, available by running \texttt{make check}. 
Most of the tests are inherited from FontForge, and the test suite had been
unmaintained and unused in FontForge for several years before FontAnvil
picked it up.  As a result, it does not have good coverage, and some of the
tests require files that I cannot legally ship.  In some cases I have not
even been able to identify what the missing files are.  If you run the test
suite, you should expect many of the tests to be skipped for missing
necessary files, and some of them to fail; and even if by some chance you
managed to get the entire suite to pass, it is unlikely that that would
really mean the software was working properly.  Having a better test suite
and software that passes it are long-term goals for the project.

After running the tests, you can read the file \texttt{tests/coverage.log}
to see a summary of how many of the PE script built-in functions were
covered by the test suite.  As of this writing, it is about 15\%.

The option \texttt{--enable-valgrind} to \texttt{configure} will make the
test suite run inside Valgrind, if you have that installed.  Valgrind
makes the tests much slower, and (with the latest versions as of this
writing) it causes at least one of them to fail on Mac OS X through no fault
of FontAnvil's, because of Valgrind's lack of support for features used by
the Mac system libraries.  For these reasons it is not the default. 
However, if enabled it will produce a lot more information in the log files
about the many ways in which FontAnvil abuses memory, and that may be useful
in debugging.

\section{FontAnvil and Tsukurimashou}

FontAnvil's reason for existence is to support Tsukurimashou, and its source
control repository is a subdirectory of the Tsukurimashou source control
repository, but FontAnvil is not a ``parasite'' of Tsukurimashou in the
technical sense of that term defined by the Tsukurimashou build system. 
Building Tsukurimashou will not automatically also build FontAnvil.
FontAnvil does not require Tsukurimashou to build.  Tsukurimashou will look
for FontAnvil and use it if found, but will not look inside its own
subdirectories---only in the usual PATH search used for other utility
programs.  If Tsukurimashou does not find an executable in the search path
named ``fontanvil,'' it will fall back to looking for one called
``fontforge,'' just like earlier versions did.

If you want to use FontAnvil to build Tsukurimashou, you should build and
install FontAnvil first in the usual way, and then start building
Tsukurimashou.

All bug reports and other tickets for FontAnvil should be filed through
the Tsukurimashou ticket tracker at
\url{http://osdn.jp/projects/tsukurimashou/ticket/}.  Set the
``Component'' field to ``FontAnvil.''

As a courtesy to Github users, Tsukurimashou's entire source control system
(including FontAnvil) is mirrored in my Github account at
\url{https://github.com/mskala}.  But osdn.jp remains the
authoritative public home of the project.  You are welcome to clone the
repository---that is why it's there---but the semi-automated gateway from
Subversion to Git is one-way.  Do not file tickets for FontAnvil on Github.

\clearpage
